<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farmer Profile Setup</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/farmer-profile.css" />
    <link rel="icon" type="image/png" href="../assests/logo_green.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Import Firebase -->
    <script type="module">
      import {
        initializeApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDFpSCsDT4fe2sQWUx5OL84rLFTkoT5HUo",
        authDomain: "stubble-management-b1b52.firebaseapp.com",
        databaseURL:
          "https://stubble-management-b1b52-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "stubble-management-b1b52",
        storageBucket: "stubble-management-b1b52.firebasestorage.app",
        messagingSenderId: "344933519470",
        appId: "1:344933519470:web:59dbcf41a80ef4e5ea167f",
        measurementId: "G-2Q7946WHEH",
      };

      // Prevent duplicate initialization
      const app =
        getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Make Firebase instances available globally
      window.auth = auth;
      window.db = db;

      // Check if user is authenticated and if they have profile data
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in
          window.userId = user.uid;

          // Fetch user name from 'users' collection
          try {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
              const userData = userDoc.data();
              document.getElementById("name").value =
                userData.fullName || userData.name || "";
            } else {
              document.getElementById("name").value = user.displayName || "";
            }
          } catch (e) {
            console.error("Error fetching user name:", e);
          }

          try {
            // Check if user profile data already exists
            const userDocRef = doc(db, "farmers", user.uid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
              // If profile data exists, redirect to dashboard
              console.log(
                "User profile already exists, redirecting to dashboard"
              );
              window.location.href = "farmer-dashboard.html";
            } else {
              // Profile data doesn't exist, allow setup
              console.log("No user profile found, continue with setup");
              document.getElementById("profile-setup-container").style.display =
                "block";
              document.getElementById("loading-container").style.display =
                "none";
            }
          } catch (error) {
            console.error("Error checking user profile:", error);
            document.getElementById("profile-setup-container").style.display =
              "block";
            document.getElementById("loading-container").style.display = "none";
          }
        } else {
          // User is not signed in, redirect to login page
          console.log("User not authenticated, redirecting to login");
          window.location.href = "login.html";
        }
      });

      // Make saveUserProfile function available globally
      window.saveUserProfile = async (userData) => {
        if (!window.userId) {
          console.error("User ID not available");
          return false;
        }

        try {
          // Save user data to Firestore
          await setDoc(doc(db, "farmers", window.userId), userData);
          console.log("User profile saved successfully");
          return true;
        } catch (error) {
          console.error("Error saving user profile:", error);
          return false;
        }
      };

      window.updateDoc = updateDoc;
      window.doc = doc;
    </script>
    <script src="../js/farmer-dashboard.js" type="module"></script>
    <style>
      /* Loading spinner styles */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-green);
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* Initially hide the profile setup container until we verify user data */
      .profile-setup-container {
        display: none;
      }

      /* Rest of your existing styles */
      .profile-setup-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: var(--shadow-md);
      }

      .profile-setup-title {
        color: var(--primary-green);
        text-align: center;
        margin-bottom: 30px;
        font-size: 2rem;
      }

      .step-container {
        display: none;
      }

      .step-container.active {
        display: block;
        animation: fadeIn 0.5s;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-dark);
        font-weight: 500;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        z-index: 5;
      }

      #preview-container {
        position: relative;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary-green);
        outline: none;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 15px;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .btn-primary {
        background-color: var(--primary-green);
        color: white;
        flex: 1;
      }

      .btn-secondary {
        background-color: #f5f5f5;
        color: var(--text-dark);
      }

      .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .progress-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
        max-width: 400px;
        margin: 0 auto 40px;
      }

      .progress-step {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        color: var(--text-dark);
        position: relative;
        z-index: 1;
      }

      .progress-step.active {
        background-color: var(--primary-green);
        color: white;
      }

      .progress-step.completed {
        background-color: var(--primary-green);
        color: white;
      }

      .progress-bar::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 2px;
        width: 100%;
        background-color: #f5f5f5;
        z-index: 0;
      }

      .progress-bar::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 2px;
        background-color: var(--primary-green);
        z-index: 0;
        transition: width 0.3s ease;
      }

      .progress-bar[data-step="1"]::after {
        width: 0%;
      }

      .progress-bar[data-step="2"]::after {
        width: 33%;
      }

      .progress-bar[data-step="3"]::after {
        width: 66%;
      }

      .progress-bar[data-step="4"]::after {
        width: 100%;
      }

      .photo-upload {
        border: 2px dashed #ddd;
        padding: 20px;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .photo-upload:hover {
        border-color: var(--primary-green);
      }

      .photo-preview {
        max-width: 200px;
        max-height: 200px;
        margin: 10px auto;
        display: none;
        border-radius: 4px;
      }

      @media (max-width: 768px) {
        .profile-setup-container {
          margin: 20px;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }

      .edit-name-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .edit-name-group input {
        flex: 1;
      }

      .edit-button {
        background: none;
        border: none;
        color: var(--primary-green);
        cursor: pointer;
        padding: 5px;
      }

      .edit-button:hover {
        color: var(--primary-dark);
      }

      .coordinates-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .coordinates-group button {
        white-space: nowrap;
        padding: 12px;
      }

      .coordinates-display {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-radius: 50%;
        border-top: 2px solid var(--primary-green);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .phone-input-group {
        display: flex;
        align-items: stretch;
        gap: 8px;
        width: 100%;
      }

      .country-code {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-weight: 500;
        color: #333;
        user-select: none;
        white-space: nowrap;
        height: 100%;
        box-sizing: border-box;
      }

      .phone-number {
        flex: 1;
      }

      .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 4px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      /* Updated phone input styling to ensure they're on the same line */
      .phone-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }

      .country-code {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-weight: 500;
        color: #333;
        user-select: none;
        white-space: nowrap;
      }

      .phone-number {
        flex: 1;
      }

      /* Style for the name field when being edited */
      .edit-name-group input:not([readonly]) {
        border-color: var(--primary-green);
        background-color: #f9fff9;
      }

      /* Styling for disabled buttons */
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Additional styles for file upload */
      .photo-upload {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        border: 2px dashed #ddd;
        padding: 20px;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .photo-upload.drag-over {
        border-color: var(--primary-green);
        background-color: rgba(0, 128, 0, 0.05);
      }

      .photo-preview-container {
        position: relative;
        margin: 10px auto;
        max-width: 200px;
      }

      .photo-remove-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: #ff4d4d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Multi-select styling */
      select[multiple] {
        height: auto;
        min-height: 120px;
        padding: 8px;
      }

      select[multiple] option {
        padding: 8px;
        margin-bottom: 4px;
        border-radius: 2px;
        background-color: #f9f9f9;
      }

      select[multiple] option:checked {
        background-color: rgba(0, 128, 0, 0.1);
        color: var(--primary-green);
      }

      /* Validation feedback styles */
      .form-control {
        position: relative;
      }

      .field-feedback {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-green);
        display: none;
      }

      .field-feedback.error {
        color: #dc3545;
      }

      .field-feedback.success {
        color: var(--primary-green);
      }

      .field-feedback.show {
        display: block;
      }

      /* Style input field with validation status */
      input.valid,
      select.valid {
        border-color: var(--primary-green);
      }

      input.invalid,
      select.invalid {
        border-color: #dc3545;
      }

      .form-group input:focus.valid,
      .form-group select:focus.valid {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 1px rgba(0, 128, 0, 0.2);
      }

      .form-group input:focus.invalid,
      .form-group select:focus.invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 1px rgba(220, 53, 69, 0.2);
      }

      /* Additional styles for edit name functionality */
      .edit-name-group input.editing {
        border-color: var(--primary-green);
        background-color: #f9fff9;
        box-shadow: 0 0 0 2px rgba(0, 128, 0, 0.1);
      }

      .edit-button {
        background: none;
        border: none;
        color: var(--primary-green);
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 4px;
        transition: all var(--transition-fast);
      }

      .edit-button:hover {
        background-color: rgba(0, 128, 0, 0.1);
        color: var(--primary-dark);
      }

      .edit-button:active {
        transform: translateY(1px);
      }

      .crops-checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 5px;
      }

      .crop-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .crop-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .crop-checkbox label {
        margin: 0;
        cursor: pointer;
      }

      /* Mobile number styling */
      .mobile-input-container {
        display: flex;
        justify-content: center;
        width: 100%;
      }

      .phone-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        max-width: 400px;
      }

      .country-code {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f5f5f5;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-weight: 500;
        color: #333;
        user-select: none;
        white-space: nowrap;
        min-width: 70px;
      }

      .phone-number {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      /* Loading spinner without text */
      .coordinates-display .loading {
        display: none;
        margin: 0 auto;
      }

      .coordinates-display.fetching .loading {
        display: inline-block;
      }

      /* Name input styling */
      .edit-name-group input[readonly] {
        background-color: #f5f5f5;
        cursor: not-allowed;
      }

      .edit-name-group input:not([readonly]) {
        background-color: #fff;
        cursor: text;
      }

      /* Style for sign out button */
      .sign-out-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .sign-out-btn:hover {
        background-color: #c82333;
        transform: translateY(-2px);
      }

      /* Adjust the loading container and profile setup container for the new layout */
      .loading-container {
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <!-- Simple Sign Out Button -->
    <button class="sign-out-btn" id="signoutBtn">
      <i class="fas fa-sign-out-alt"></i> Sign Out
    </button>

    <!-- Loading spinner while checking user data -->
    <div id="loading-container" class="loading-container">
      <div class="spinner"></div>
      <p>Loading your profile data...</p>
    </div>

    <div id="profile-setup-container" class="profile-setup-container">
      <h1 class="profile-setup-title">Farmer Profile Setup</h1>

      <div class="progress-bar" data-step="1">
        <div class="progress-step active">1</div>
        <div class="progress-step">2</div>
        <div class="progress-step">3</div>
        <div class="progress-step">4</div>
      </div>

      <!-- Step 1: Basic Information -->
      <div class="step-container active" id="step1">
        <div class="form-group">
          <label for="name">Full Name</label>
          <div class="edit-name-group">
            <input type="text" id="name" name="name" required readonly />
            <button class="edit-button" id="editNameBtn">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <div class="error-message" id="name-error"></div>
        </div>

        <div class="form-group">
          <label for="dob">Date of Birth</label>
          <div class="form-control">
            <input
              type="text"
              id="dob"
              name="dob"
              required
              placeholder="Select date"
            />
            <div class="field-feedback" id="dob-feedback"></div>
          </div>
          <div class="error-message" id="dob-error"></div>
        </div>

        <div class="form-group">
          <label for="mobile">Mobile Number</label>
          <div class="mobile-input-container">
            <div class="phone-input-group">
              <div class="country-code">
                <span class="flag">🇮🇳</span>
                <span>+91</span>
              </div>
              <input
                type="tel"
                id="mobile"
                name="mobile"
                class="phone-number"
                pattern="[0-9]{10}"
                maxlength="10"
                required
                placeholder="Enter 10 digit mobile number"
              />
            </div>
          </div>
          <div class="error-message" id="mobile-error"></div>
        </div>

        <div class="form-group">
          <label for="language">Preferred Language</label>
          <select id="language" name="language" required>
            <option value="">Select Language</option>
            <option value="assamese">Assamese - অসমীয়া</option>
            <option value="bengali">Bengali - বাংলা</option>
            <option value="gujarati">Gujarati - ગુજરાતી</option>
            <option value="hindi">Hindi - हिंदी</option>
            <option value="kannada">Kannada - ಕನ್ನಡ</option>
            <option value="kashmiri">Kashmiri - کٲشُر</option>
            <option value="konkani">Konkani - कोंकणी</option>
            <option value="malayalam">Malayalam - മലയാളം</option>
            <option value="manipuri">Manipuri - মৈতৈলোন্</option>
            <option value="marathi">Marathi - मराठी</option>
            <option value="nepali">Nepali - नेपाली</option>
            <option value="odia">Odia - ଓଡ଼ିଆ</option>
            <option value="punjabi">Punjabi - ਪੰਜਾਬੀ</option>
            <option value="sanskrit">Sanskrit - संस्कृतम्</option>
            <option value="sindhi">Sindhi - سنڌي</option>
            <option value="tamil">Tamil - தமிழ்</option>
            <option value="telugu">Telugu - తెలుగు</option>
            <option value="urdu">Urdu - اردو</option>
            <option value="english">English</option>
          </select>
          <div class="error-message" id="language-error"></div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="step1Next" disabled>Next</button>
        </div>
      </div>

      <!-- Step 2: Location Information -->
      <div class="step-container" id="step2">
        <div class="form-group">
          <label for="state">State</label>
          <select id="state" name="state" required>
            <option value="">Select State</option>
            <!-- States will be populated from API -->
          </select>
        </div>

        <div class="form-group">
          <label for="district">District</label>
          <select id="district" name="district" required disabled>
            <option value="">Select District</option>
            <!-- Districts will be populated based on state selection -->
          </select>
        </div>

        <div class="form-group">
          <label for="village">Village/Town</label>
          <input type="text" id="village" name="village" required />
        </div>

        <div class="form-group">
          <label for="pincode">Pincode</label>
          <div class="form-control">
            <input
              type="text"
              id="pincode"
              name="pincode"
              pattern="[0-9]{6}"
              maxlength="6"
              placeholder="Enter 6 digit pincode"
            />
            <div class="field-feedback" id="pincode-feedback"></div>
          </div>
          <div class="error-message" id="pincode-error"></div>
        </div>

        <div class="form-group">
          <label>Coordinates (Optional)</label>
          <div class="coordinates-group">
            <input
              type="text"
              id="coordinates"
              readonly
              placeholder="Latitude, Longitude"
            />
            <button class="btn btn-secondary" type="button" id="getLocationBtn">
              <i class="fas fa-map-marker-alt"></i> Get Location
            </button>
          </div>
          <div id="coordinates-status" class="coordinates-display">
          </div>
        </div>

        <div class="button-group">
          <button
            class="btn btn-secondary"
            type="button"
            onclick="previousStep(2)"
          >
            Previous
          </button>
          <button class="btn btn-primary" type="button" id="step2Next" disabled>
            Next
          </button>
        </div>
      </div>

      <!-- Step 3: Farm Information -->
      <div class="step-container" id="step3">
        <div class="form-group">
          <label for="soil-type">Soil Type</label>
          <select id="soil-type" name="soil-type" required>
            <option value="">Select Soil Type</option>
            <option value="alluvial">Alluvial Soil</option>
            <option value="black">Black Soil</option>
            <option value="red">Red Soil</option>
            <option value="laterite">Laterite Soil</option>
            <!-- Add more soil types as needed -->
          </select>
        </div>

        <div class="form-group">
          <label for="crops">Types of Crops Grown</label>
          <div class="crops-checkbox-group">
            <div class="crop-checkbox">
              <input type="checkbox" id="wheat" name="crops" value="wheat" />
              <label for="wheat">Wheat</label>
            </div>
            <div class="crop-checkbox">
              <input type="checkbox" id="rice" name="crops" value="rice" />
              <label for="rice">Rice</label>
            </div>
            <div class="crop-checkbox">
              <input type="checkbox" id="corn" name="crops" value="corn" />
              <label for="corn">Corn</label>
            </div>
            <div class="crop-checkbox">
              <input
                type="checkbox"
                id="sugarcane"
                name="crops"
                value="sugarcane"
              />
              <label for="sugarcane">Sugarcane</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="land-size">Land Size (in acres)</label>
          <input
            type="number"
            id="land-size"
            name="land-size"
            min="0"
            step="0.1"
            required
          />
        </div>

        <div class="form-group">
          <label for="photo">Profile Photo</label>
          <div class="photo-upload" id="photo-drop-zone">
            <i class="fas fa-camera"></i>
            <p>Click to upload or drop photo here</p>
            <input
              type="file"
              id="photo-input"
              accept="image/*"
              style="display: none"
            />
            <div
              class="photo-preview-container"
              id="preview-container"
              style="display: none"
            >
              <img id="photo-preview" class="photo-preview" />
              <button type="button" class="photo-remove-btn" id="remove-photo">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button
            class="btn btn-secondary"
            type="button"
            onclick="previousStep(3)"
          >
            Previous
          </button>
          <button class="btn btn-primary" type="button" id="submitBtn" disabled>
            Submit
          </button>
        </div>
      </div>
    </div>

    <script>
      // Add JavaScript for form functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Name field edit functionality
        const nameInput = document.getElementById("name");
        const editNameBtn = document.getElementById("editNameBtn");

        if (nameInput && editNameBtn) {
          // Make sure name field starts as readonly
          nameInput.setAttribute("readonly", true);

          editNameBtn.addEventListener("click", function (e) {
            e.preventDefault();
            console.log(
              "Edit button clicked, current readonly state:",
              nameInput.readOnly
            );

            if (nameInput.readOnly) {
              // Switch to edit mode
              nameInput.readOnly = false;
              nameInput.focus();
              nameInput.classList.add("editing");
              editNameBtn.innerHTML = '<i class="fas fa-check"></i>';
              console.log("Enabled editing mode");
            } else {
              // Switch back to readonly mode
              nameInput.readOnly = true;
              nameInput.classList.remove("editing");
              editNameBtn.innerHTML = '<i class="fas fa-edit"></i>';
              console.log(
                "Disabled editing mode, value saved:",
                nameInput.value
              );

              // Validate after saving
              validateStep1();
            }
          });
        } else {
          console.error("Name input or edit button not found!");
        }

        // Mobile number validation - allow only numbers
        const mobileInput = document.getElementById("mobile");
        mobileInput.addEventListener("input", function (e) {
          e.target.value = e.target.value.replace(/[^0-9]/g, "");
          if (e.target.value !== "") {
            validateMobileNumber(e.target.value);
          } else {
            clearValidation(
              mobileInput,
              document.getElementById("mobile-error")
            );
          }
        });

        // Add blur event to trigger validation when user leaves the field
        mobileInput.addEventListener("blur", function () {
          if (this.value !== "") {
            validateMobileNumber(this.value);
          }
        });

        // Pincode validation - only allow numbers and check length
        const pincodeInput = document.getElementById("pincode");
        pincodeInput.addEventListener("input", function (e) {
          e.target.value = e.target.value.replace(/[^0-9]/g, "");
          if (e.target.value !== "") {
            validatePincode(e.target.value);
          } else {
            clearValidation(
              pincodeInput,
              document.getElementById("pincode-error")
            );
          }
        });

        // Add blur event for pincode
        pincodeInput.addEventListener("blur", function () {
          if (this.value !== "") {
            validatePincode(this.value);
          }
        });

        // Function to validate Pincode
        function validatePincode(value) {
          const errorElement = document.getElementById("pincode-error");
          const feedbackElement = document.getElementById("pincode-feedback");

          if (!value) {
            showError(
              pincodeInput,
              errorElement,
              "Pincode is required",
              feedbackElement
            );
            return false;
          } else if (!/^\d{6}$/.test(value)) {
            showError(
              pincodeInput,
              errorElement,
              "Pincode must be exactly 6 digits",
              feedbackElement
            );
            return false;
          } else {
            showSuccess(pincodeInput, errorElement, feedbackElement);
            return true;
          }
        }

        // Function to validate Mobile Number
        function validateMobileNumber(value) {
          const errorElement = document.getElementById("mobile-error");
          const mobileInput = document.getElementById("mobile");

          if (!value) {
            showError(mobileInput, errorElement, "Mobile number is required");
            return false;
          } else if (value.length !== 10) {
            showError(
              mobileInput,
              errorElement,
              "Mobile number must be exactly 10 digits"
            );
            return false;
          } else {
            showSuccess(mobileInput, errorElement);
            return true;
          }
        }

        // Date of birth validation
        const dobInput = document.getElementById("dob");

        dobInput.addEventListener("change", function () {
          if (this.value !== "") {
            validateDOB(this.value);
          } else {
            clearValidation(dobInput, document.getElementById("dob-error"));
          }
        });

        // Add blur event for DOB
        dobInput.addEventListener("blur", function () {
          if (this.value !== "") {
            validateDOB(this.value);
          }
        });

        // Function to validate DOB
        function validateDOB(value) {
          const errorElement = document.getElementById("dob-error");
          const feedbackElement = document.getElementById("dob-feedback");

          if (!value) {
            showError(
              dobInput,
              errorElement,
              "Date of birth is required",
              feedbackElement
            );
            return false;
          }

          const selectedDate = new Date(value);
          const today = new Date();

          // Check if it's a valid date
          if (isNaN(selectedDate.getTime())) {
            showError(
              dobInput,
              errorElement,
              "Please enter a valid date",
              feedbackElement
            );
            return false;
          }

          // Check if date is in the future
          if (selectedDate > today) {
            showError(
              dobInput,
              errorElement,
              "Date of birth cannot be in the future",
              feedbackElement
            );
            return false;
          }

          // Check for minimum age (18 years)
          const minAgeDate = new Date();
          minAgeDate.setFullYear(today.getFullYear() - 18);

          if (selectedDate > minAgeDate) {
            showError(
              dobInput,
              errorElement,
              "You must be at least 18 years old",
              feedbackElement
            );
            return false;
          }

          // Check if the person is too old (e.g., over 120 years)
          const maxAgeDate = new Date();
          maxAgeDate.setFullYear(today.getFullYear() - 120);

          if (selectedDate < maxAgeDate) {
            showError(
              dobInput,
              errorElement,
              "Please enter a realistic date of birth",
              feedbackElement
            );
            return false;
          }

          showSuccess(dobInput, errorElement, feedbackElement);
          return true;
        }

        // Helper functions for validation UI
        function showError(
          inputElement,
          errorElement,
          message,
          feedbackElement = null
        ) {
          if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add("show");
          }

          if (inputElement) {
            inputElement.classList.remove("valid");
            inputElement.classList.add("invalid");
          }

          if (feedbackElement) {
            feedbackElement.innerHTML = '<i class="fas fa-times"></i>';
            feedbackElement.classList.remove("success");
            feedbackElement.classList.add("error", "show");
          }
        }

        function showSuccess(
          inputElement,
          errorElement,
          feedbackElement = null
        ) {
          if (errorElement) {
            errorElement.textContent = "";
            errorElement.classList.remove("show");
          }

          if (inputElement) {
            inputElement.classList.remove("invalid");
            inputElement.classList.add("valid");
          }

          if (feedbackElement) {
            feedbackElement.innerHTML = '<i class="fas fa-check"></i>';
            feedbackElement.classList.remove("error");
            feedbackElement.classList.add("success", "show");
          }
        }

        function clearValidation(
          inputElement,
          errorElement,
          feedbackElement = null
        ) {
          if (errorElement) {
            errorElement.textContent = "";
            errorElement.classList.remove("show");
          }

          if (inputElement) {
            inputElement.classList.remove("valid", "invalid");
          }

          if (feedbackElement) {
            feedbackElement.classList.remove("error", "success", "show");
          }
        }

        // Function to validate all fields in step 1
        function validateStep1() {
          const name = document.getElementById("name").value;
          const dob = document.getElementById("dob").value;
          const mobile = document.getElementById("mobile").value;
          const language = document.getElementById("language").value;

          let isValid = true;

          // Only validate fields that have been interacted with
          if (name !== "") {
            if (!name || name.trim() === "") {
              const errorEl = document.getElementById("name-error");
              if (errorEl) {
                errorEl.textContent = "Name is required";
                errorEl.classList.add("show");
              }
              isValid = false;
            }
          }

          if (dob !== "") {
            isValid = validateDOB(dob) && isValid;
          }

          if (mobile !== "") {
            isValid = validateMobileNumber(mobile) && isValid;
          }

          if (language !== "") {
            if (!language) {
              const errorEl = document.getElementById("language-error");
              if (errorEl) {
                errorEl.textContent = "Please select a language";
                errorEl.classList.add("show");
              }
              isValid = false;
            }
          }

          // Only enable next button if all fields are filled AND valid
          const allFieldsFilled = name && dob && mobile && language;
          document.getElementById("step1Next").disabled = !(
            allFieldsFilled && isValid
          );

          return isValid;
        }

        // Function to validate all fields in step 2
        function validateStep2() {
          const state = document.getElementById("state").value;
          const district = document.getElementById("district").value;
          const village = document.getElementById("village").value;
          const pincode = document.getElementById("pincode").value;

          let isValid = true;

          if (!state) isValid = false;
          if (!district) isValid = false;
          if (!village || village.trim() === "") isValid = false;
          if (!pincode || !validatePincode(pincode)) isValid = false;

          // Enable/disable the next button based on validation
          const requiredFieldsFilled = state && district && village && pincode;
          document.getElementById("step2Next").disabled = !(
            requiredFieldsFilled && isValid
          );

          return isValid;
        }

        // Add these functions to handle image processing
        function compressAndConvertImage(file, maxWidth, maxHeight, quality) {
          return new Promise((resolve, reject) => {
            // Create a FileReader to read the file
            const reader = new FileReader();

            // Set up the reader onload callback
            reader.onload = function (event) {
              // Create an image to get the dimensions
              const img = new Image();

              img.onload = function () {
                // Calculate new dimensions while maintaining aspect ratio
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                  height = (height * maxWidth) / width;
                  width = maxWidth;
                }

                if (height > maxHeight) {
                  width = (width * maxHeight) / height;
                  height = maxHeight;
                }

                // Create a canvas to resize the image
                const canvas = document.createElement("canvas");
                canvas.width = width;
                canvas.height = height;

                // Draw the resized image
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);

                // Convert canvas to base64 string
                const base64String = canvas.toDataURL("image/jpeg", quality);

                // Resolve the promise with the compressed base64 string
                resolve(base64String);
              };

              img.onerror = function () {
                reject(new Error("Failed to load image"));
              };

              // Set the source of the image to the FileReader result
              img.src = event.target.result;
            };

            reader.onerror = function () {
              reject(new Error("Failed to read file"));
            };

            // Read the file as a data URL
            reader.readAsDataURL(file);
          });
        }

        // Function to validate all fields in step 3
        function validateStep3() {
          const soilType = document.getElementById("soil-type").value;
          const cropCheckboxes = document.querySelectorAll(
            'input[name="crops"]:checked'
          );
          const landSize = document.getElementById("land-size").value;

          let isValid = true;

          if (!soilType) isValid = false;
          if (cropCheckboxes.length === 0) isValid = false;
          if (!landSize || landSize <= 0) isValid = false;

          // Enable/disable the submit button based on validation
          document.getElementById("submitBtn").disabled = !isValid;

          return isValid;
        }

        // Add input event listeners to all fields to validate in real-time
        document.getElementById("name").addEventListener("input", function () {
          if (this.value !== "") {
            validateStep1();
          }
        });

        document.getElementById("dob").addEventListener("change", function () {
          if (this.value !== "") {
            validateStep1();
          }
        });

        document
          .getElementById("mobile")
          .addEventListener("input", function () {
            if (this.value !== "") {
              validateStep1();
            }
          });

        document
          .getElementById("language")
          .addEventListener("change", function () {
            if (this.value !== "") {
              validateStep1();
            }
          });

        document
          .getElementById("state")
          .addEventListener("change", function () {
            if (this.value !== "") {
              validateStep2();
            }
          });

        document
          .getElementById("district")
          .addEventListener("change", function () {
            if (this.value !== "") {
              validateStep2();
            }
          });

        document
          .getElementById("village")
          .addEventListener("input", function () {
            if (this.value !== "") {
              validateStep2();
            }
          });

        document
          .getElementById("pincode")
          .addEventListener("input", function () {
            if (this.value !== "") {
              validateStep2();
            }
          });

        document
          .getElementById("soil-type")
          .addEventListener("change", function () {
            if (this.value !== "") {
              validateStep3();
            }
          });

        document.querySelectorAll('input[name="crops"]').forEach((checkbox) => {
          checkbox.addEventListener("change", validateStep3);
        });

        document
          .getElementById("land-size")
          .addEventListener("input", function () {
            if (this.value !== "") {
              validateStep3();
            }
          });

        // Next button for step 1
        document
          .getElementById("step1Next")
          .addEventListener("click", function () {
            if (validateStep1()) {
              document.getElementById("step1").classList.remove("active");
              document.getElementById("step2").classList.add("active");
              document
                .querySelector(".progress-bar")
                .setAttribute("data-step", "2");
              document
                .querySelectorAll(".progress-step")[0]
                .classList.add("completed");
              document
                .querySelectorAll(".progress-step")[1]
                .classList.add("active");
              validateStep2();
            }
          });

        // Next button for step 2
        document
          .getElementById("step2Next")
          .addEventListener("click", function () {
            if (validateStep2()) {
              nextStep(2);
              validateStep3();
            }
          });

        // Update the submit button for step 3
        document
          .getElementById("submitBtn")
          .addEventListener("click", async function () {
            if (validateStep3()) {
              // Show loading state
              this.disabled = true;
              this.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Saving...';

              // Collect all form data
              const userData = {
                personalInfo: {
                  fullName: document.getElementById("name").value,
                  dateOfBirth: document.getElementById("dob").value,
                  mobileNumber: document.getElementById("mobile").value,
                  preferredLanguage: document.getElementById("language").value,
                },
                location: {
                  state: document.getElementById("state").value,
                  district: document.getElementById("district").value,
                  village: document.getElementById("village").value,
                  pincode: document.getElementById("pincode").value,
                  coordinates:
                    document.getElementById("coordinates").value || null,
                },
                farmInfo: {
                  soilType: document.getElementById("soil-type").value,
                  landSize: parseFloat(
                    document.getElementById("land-size").value
                  ),
                  crops: Array.from(
                    document.querySelectorAll('input[name="crops"]:checked')
                  ).map((checkbox) => checkbox.value),
                },
                profileComplete: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
              };

              // Add profile photo if available
              if (photoInput.dataset.base64) {
                userData.profilePhoto = photoInput.dataset.base64;
              }

              // Save data to Firebase
              try {
                const success = await window.saveUserProfile(userData);

                if (success) {
                  // Update the main user document
                  await window.updateDoc(
                    window.doc(db, "users", window.userId),
                    {
                      profileComplete: true,
                      updatedAt: new Date().toISOString(),
                      // Store a flag that the user has a profile photo if it exists
                      hasProfilePhoto: !!photoInput.dataset.base64,
                    }
                  );

                  // Update the role-specific document
                  await window.updateDoc(
                    window.doc(db, "farmers", window.userId),
                    {
                      registrationComplete: true,
                      updatedAt: new Date().toISOString(),
                    }
                  );

                  // Show success message
                  alert("Profile successfully saved!");
                  // Redirect to dashboard
                  window.location.href = "farmer-dashboard.html";
                } else {
                  // Show error and re-enable button
                  alert("Failed to save profile. Please try again.");
                  this.disabled = false;
                  this.innerHTML = "Submit";
                }
              } catch (error) {
                console.error("Error in profile submission:", error);
                alert("An error occurred. Please try again.");
                this.disabled = false;
                this.innerHTML = "Submit";
              }
            }
          });

        // Initialize flatpickr for date selection
        flatpickr("#dob", {
          dateFormat: "Y-m-d",
          maxDate: new Date(
            new Date().setFullYear(new Date().getFullYear() - 18)
          ), // Set max date to 18 years ago
          disableMobile: "true",
          onChange: function (selectedDates, dateStr) {
            if (dateStr !== "") {
              validateDOB(dateStr);
              validateStep1();
            }
          },
        });

        // Function to get location
        document
  .getElementById("getLocationBtn")
  .addEventListener("click", function () {
    const statusElement = document.getElementById("coordinates-status");
    const coordinatesInput = document.getElementById("coordinates");
    const locationBtn = this; // Reference to the button itself

    // Disable button and show loading state
    locationBtn.disabled = true;
    const originalButtonText = locationBtn.innerHTML;
    locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
    
    statusElement.classList.add("fetching");

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          coordinatesInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          statusElement.textContent = "Location fetched successfully";
          statusElement.style.color = "green";
          statusElement.classList.remove("fetching");
          
          // Re-enable button and restore original text
          locationBtn.disabled = false;
          locationBtn.innerHTML = originalButtonText;
        },
        function (error) {
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.style.color = "red";
          statusElement.classList.remove("fetching");
          
          // Re-enable button and restore original text
          locationBtn.disabled = false;
          locationBtn.innerHTML = originalButtonText;
        },
        // Add options to improve accuracy and set timeout
        { 
          enableHighAccuracy: true,
          timeout: 10000, // 10 seconds timeout
          maximumAge: 0
        }
      );
    } else {
      statusElement.textContent = "Geolocation is not supported by this browser";
      statusElement.style.color = "red";
      statusElement.classList.remove("fetching");
      
      // Re-enable button and restore original text
      locationBtn.disabled = false;
      locationBtn.innerHTML = originalButtonText;
    }
  });
        // Functions for other steps navigation
        window.nextStep = function (currentStep) {
          document
            .getElementById(`step${currentStep}`)
            .classList.remove("active");
          document
            .getElementById(`step${currentStep + 1}`)
            .classList.add("active");
          document
            .querySelector(".progress-bar")
            .setAttribute("data-step", currentStep + 1);
          document
            .querySelectorAll(".progress-step")
            [currentStep - 1].classList.add("completed");
          document
            .querySelectorAll(".progress-step")
            [currentStep].classList.add("active");
        };

        window.previousStep = function (currentStep) {
          document
            .getElementById(`step${currentStep}`)
            .classList.remove("active");
          document
            .getElementById(`step${currentStep - 1}`)
            .classList.add("active");
          document
            .querySelector(".progress-bar")
            .setAttribute("data-step", currentStep - 1);
          document
            .querySelectorAll(".progress-step")
            [currentStep - 1].classList.remove("active");
        };

        // Photo upload functionality
        const photoInput = document.getElementById("photo-input");
        const photoPreview = document.getElementById("photo-preview");
        const previewContainer = document.getElementById("preview-container");
        const removePhotoBtn = document.getElementById("remove-photo");
        const dropZone = document.getElementById("photo-drop-zone");

        // ...existing code...
        photoInput.addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (file) {
            try {
              // Show loading indicator
              const loadingIndicator = document.createElement("div");
              loadingIndicator.className = "loading-indicator";
              loadingIndicator.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Processing image...';
              previewContainer.appendChild(loadingIndicator);

              // Compress the image (max width 500px, max height 500px, quality 0.7)
              const base64String = await compressAndConvertImage(
                file,
                500,
                500,
                0.7
              );

              // Update the preview
              photoPreview.src = base64String;
              photoPreview.style.display = "block"; // Make the image visible
              previewContainer.style.display = "block";

              // Remove loading indicator
              previewContainer.removeChild(loadingIndicator);

              // Store the base64 string for later use in form submission
              photoInput.dataset.base64 = base64String;
            } catch (error) {
              console.error("Error processing image:", error);
              alert("Error processing image. Please try again.");
            }
          }
        });
        // ...existing code...
        // ...existing code...
        removePhotoBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          photoInput.value = "";
          photoPreview.src = "";
          photoPreview.style.display = "none"; // Hide the image
          previewContainer.style.display = "none";
          delete photoInput.dataset.base64; // Remove stored base64 data
        });
        // ...existing code...

        // Drag and drop functionality
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          dropZone.classList.add("drag-over");
        }

        function unhighlight() {
          dropZone.classList.remove("drag-over");
        }

        dropZone.addEventListener("drop", handleDrop, false);

        // Update the drop handler to use the compression function
        function handleDrop(e) {
          const dt = e.dataTransfer;
          const file = dt.files[0];

          if (file && file.type.match("image.*")) {
            // Set the file input for form validation purposes
            photoInput.files = dt.files;

            // Show loading indicator
            const loadingIndicator = document.createElement("div");
            loadingIndicator.className = "loading-indicator";
            loadingIndicator.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Processing image...';
            previewContainer.appendChild(loadingIndicator);

            // Compress and convert the image
            compressAndConvertImage(file, 500, 500, 0.7)
              .then((base64String) => {
                // Update the preview
                photoPreview.src = base64String;
                photoPreview.style.display = "block"; // Make the image visible
                previewContainer.style.display = "block";

                // Store the base64 string for later use
                photoInput.dataset.base64 = base64String;

                // Remove loading indicator
                if (previewContainer.contains(loadingIndicator)) {
                  previewContainer.removeChild(loadingIndicator);
                }
              })
              .catch((error) => {
                console.error("Error processing image:", error);
                alert("Error processing image. Please try again.");

                // Remove loading indicator
                if (previewContainer.contains(loadingIndicator)) {
                  previewContainer.removeChild(loadingIndicator);
                }
              });
          }
        }

        dropZone.addEventListener("click", function () {
          photoInput.click();
        });

        // Initial validation
        validateStep1();
      });

      // Add signout functionality
      document
        .getElementById("signoutBtn")
        .addEventListener("click", async () => {
          try {
            await window.auth.signOut(); // Changed from signOut() to window.auth.signOut()
            window.location.href = "/index.html";
          } catch (error) {
            console.error("Error signing out:", error);
            alert("Error signing out. Please try again.");
          }
        });

      let stateDistrictData = {};

      // Load the list.json file
      fetch("../js/list.json")
        .then((response) => response.json())
        .then((data) => {
          stateDistrictData = data;
          populateStates();
        })
        .catch((error) => {
          console.error("Error loading state/district data:", error);
        });

      function populateStates() {
        const stateSelect = document.getElementById("state");
        stateSelect.innerHTML = '<option value="">Select State</option>';
        Object.keys(stateDistrictData).forEach((state) => {
          const option = document.createElement("option");
          option.value = state;
          option.textContent = state;
          stateSelect.appendChild(option);
        });
      }

      document.getElementById("state").addEventListener("change", function () {
        const selectedState = this.value;
        const districtSelect = document.getElementById("district");
        districtSelect.innerHTML = '<option value="">Select District</option>';
        if (selectedState && stateDistrictData[selectedState]) {
          stateDistrictData[selectedState].forEach((district) => {
            const option = document.createElement("option");
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
          });
          districtSelect.disabled = false;
        } else {
          districtSelect.disabled = true;
        }
      });
    </script>
  </body>
</html>
